<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Happy Anniversary ‚Äî Jigsaw (90 pieces)</title>
<style>
:root{
  --bg1:#ffd6ec; --bg2:#d6f0ff; --accent:#e60073; --accent-soft:#ff80bf;
  --card:#fff; --rose-border:#ffe0ef; --danger:#ff4d6d; --good:#48d28a;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:Inter, "Segoe UI", system-ui, Arial, sans-serif;
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  color:#222;
  min-height:100vh;
  display:flex;align-items:center;justify-content:center;padding:22px;
}

/* HOME / APP CARD */
.card{
  width:960px; max-width:96%; background:var(--card); border-radius:16px;
  padding:22px; border:4px solid var(--rose-border); box-shadow:0 14px 40px rgba(0,0,0,0.12);
}
.header{display:flex;align-items:center;gap:16px;justify-content:space-between}
.title{color:var(--accent); font-size:22px; margin:0}
.subtitle{color:#444;font-size:14px;margin-top:6px}

/* play area */
.main{display:flex;gap:18px;margin-top:14px;align-items:flex-start}
.left{flex:1}
.right{width:230px;min-width:180px}

/* board wrapper */
.board-wrap{
  background:linear-gradient(180deg,#fff,#fffaf8);padding:12px;border-radius:12px;border:2px solid var(--rose-border);
  box-shadow:0 8px 22px rgba(0,0,0,0.06);
  display:flex;flex-direction:column;align-items:center;gap:10px;
}

/* the board (canvas container) */
.board{
  width:880px; max-width:100%; background:#f3f3f3; border-radius:8px; overflow:hidden; display:block;
  touch-action:none; position:relative;
  box-shadow: inset 0 2px 0 rgba(255,255,255,0.6);
}

/* control box */
.controls{background:var(--card); padding:12px;border-radius:10px;border:1px solid #f5e7ef}
.btn{
  display:inline-block;padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(180deg,var(--accent-soft),var(--accent));
  color:white;font-weight:700;cursor:pointer;margin:6px 0;width:100%;
  box-shadow:0 10px 22px rgba(230,0,115,0.12);
}
.small{font-size:13px;padding:8px}

/* piece DOM overlays will be absolute elements inside board container */
.piece{
  position:absolute; touch-action:none; cursor:grab; user-select:none;
  transition: box-shadow 140ms ease, transform 220ms cubic-bezier(.2,.9,.3,1);
  border-radius:6px; overflow:hidden;
}
.piece.dragging{cursor:grabbing; transform:scale(1.02); box-shadow:0 18px 40px rgba(0,0,0,0.24); z-index:9999}
.piece.correct{ animation: fitPop .42s cubic-bezier(.2,.9,.3,1); box-shadow:0 12px 28px rgba(72,210,138,0.18); outline:3px solid rgba(72,210,138,0.85); outline-offset:-6px}
@keyframes fitPop{ 0%{ transform:scale(1.02)} 50%{transform:scale(1.12)} 100%{transform:scale(1)} }

.piece.wrong{ outline:2px solid rgba(255,77,109,0.95); outline-offset:-4px; animation: glowRed 900ms ease-out;}
@keyframes glowRed{ 0%{ box-shadow:0 0 0 rgba(255,77,109,0.0);} 40%{ box-shadow:0 0 10px rgba(255,77,109,0.45);} 100%{ box-shadow:0 0 0 rgba(255,77,109,0);} }

.status{font-size:13px;color:#555;margin-top:8px}
.win-overlay{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);z-index:20000;
}
.win-card{background:var(--card);padding:26px;border-radius:12px;border:3px solid var(--rose-border);box-shadow:0 18px 40px rgba(0,0,0,0.25);text-align:center}
.win-card h2{color:var(--accent);margin:0 0 6px 0}

.note{font-size:13px;color:#666;margin-top:8px}
.footer{margin-top:12px;font-size:12px;color:#777;text-align:center}
@media (max-width:1100px){
  .board{width:720px}
}
@media (max-width:820px){
  .main{flex-direction:column}
  .right{width:100%}
  .board{width:92vw}
}
</style>
</head>
<body>
  <div class="card" role="main" aria-label="Anniversary jigsaw app">
    <div class="header">
      <div>
        <h1 class="title">Happy Aniversary, my silly bun bun üíï</h1>
        <div class="subtitle">A little surprise puzzle for you</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:13px;color:#666">Made with ‚ô•</div>
      </div>
    </div>

    <!-- HOME with Play button -->
    <div id="homeView" style="margin-top:18px;background:linear-gradient(180deg,#fff,#fff7fb);padding:14px;border-radius:12px;border:1px solid var(--rose-border);display:block">
      <strong>How to play</strong>
      <div style="font-size:13px;color:#555;margin-top:8px;">
        Solve this small puzzle to reveal the favourite photo of me and wifey &gt;:p
      </div>
      <div style="display:flex;gap:16px;align-items:center;margin-top:12px;">
        <div style="flex:1">
          <div style="background:#fff;padding:10px;border-radius:10px;border:1px solid #f3e6ee;color:#444">
            Click <strong>Play</strong> to start the puzzle. Drag pieces to move them. Pieces snap when very close to correct; wrong placements flash a thin red glow.
          </div>
        </div>
        <div style="width:180px">
          <button id="playBtn" class="btn">Play</button>
        </div>
      </div>
    </div>

    <!-- GAME VIEW -->
    <div id="gameView" style="display:none;margin-top:16px">
      <div class="main">
        <div class="left">
          <div class="board-wrap">
            <div id="board" class="board" aria-label="Puzzle board" ></div>
            <div class="note">Pieces: <span id="placedCount">0</span>/90 &nbsp; ‚Ä¢ &nbsp; Time: <span id="time">00:00</span></div>
          </div>
        </div>

        <div class="right">
          <div class="controls">
            <div style="font-weight:700;color:var(--accent);margin-bottom:8px">Controls</div>
            <button id="shuffleBtn" class="small btn">Shuffle</button>
            <button id="resetBtn" class="small" style="background:linear-gradient(180deg,#f3f3f3,#e9e9e9);color:#222;border:1px solid #ddd">Reset (Auto-solve)</button>
            <button id="snapshotBtn" class="small" style="background:linear-gradient(180deg,#fff4f9,#ffdff0);color:#b1004b">Download Snapshot</button>
            <div class="status" style="margin-top:10px">Tip: Pieces have jigsaw tabs & holes to make matching easier.</div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Win overlay -->
  <div id="winOverlay" class="win-overlay" style="display:none">
    <div class="win-card">
      <h2>All done! üéâ</h2>
      <p style="margin:12px 0">Happy Anniversary ‚Äî you revealed the photo ‚ù§Ô∏è</p>
      <button id="closeWin" class="btn" style="padding:10px 18px">Close</button>
    </div>
  </div>

<script>
/*
 Standalone Jigsaw 90-piece (10 x 9) with real jigsaw-shaped pieces.
 The main image is embedded as a data URL (so no upload needed).
 Save as jigsaw90.html and open in browser.
*/

// ---------- EMBEDDED IMAGE DATA (your uploaded image) ----------
const IMAGE_DATA = "data:image/png;base64,REPLACE_BASE64";
// ---------- end image ----------

// We'll replace the placeholder token with actual base64 when injecting this file.
// If you saved the file exactly as given here, replace REPLACE_BASE64 with the base64 string.
// (Below in the instruction I include the full file already embedded.)

// CONFIG
const COLS = 10;
const ROWS = 9;
const TOTAL = COLS * ROWS;
const BOARD_W = 880;   // width in px used for board (keeps ratio)
const BOARD_H = 720;   // height in px
const PIECE_W = BOARD_W / COLS;
const PIECE_H = BOARD_H / ROWS;
const SNAP_TOLERANCE = Math.max(PIECE_W, PIECE_H) * 0.28; // tolerance for snapping (generous)
const boardEl = document.getElementById('board');
const playBtn = document.getElementById('playBtn');
const homeView = document.getElementById('homeView');
const gameView = document.getElementById('gameView');
const shuffleBtn = document.getElementById('shuffleBtn');
const resetBtn = document.getElementById('resetBtn');
const placedCountEl = document.getElementById('placedCount');
const timeEl = document.getElementById('time');
const winOverlay = document.getElementById('winOverlay');
const closeWin = document.getElementById('closeWin');
const snapshotBtn = document.getElementById('snapshotBtn');

let img = new Image();
img.src = IMAGE_DATA;
let pieces = []; // objects for each piece
let connectors = []; // connectors grid to ensure compatibility (tab: 1, hole: -1, flat:0)
let dragging = null; // {el, piece, offsetX, offsetY, startX,startY, lastPositions}
let placedCount = 0;
let timerInterval = null;
let startTime = null;

// init board size
boardEl.style.width = BOARD_W + 'px';
boardEl.style.height = BOARD_H + 'px';
boardEl.style.position = 'relative';

// Helper: format time
function fmtTime(ms){
  const s = Math.floor(ms/1000);
  const mm = String(Math.floor(s/60)).padStart(2,'0');
  const ss = String(s%60).padStart(2,'0');
  return mm + ':' + ss;
}

function startTimer(){
  startTime = Date.now();
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    timeEl.textContent = fmtTime(Date.now() - startTim
